@*
* This template takes a single argument, a String containing a
* message to display.
*@
@(message: String)

@*
* Call the `main` template with two arguments. The first
* argument is a `String` with the title of the page, the second
* argument is an `Html` object containing the body of the page.
*@
@main("Welcome to the Fibonacci Server") {

<body onload="reset()">
<script language="JavaScript">
    var currentId = 0

    function reset() {
        document.getElementById("fib_input_" + currentId).value = ""
        document.getElementById("fib_input_" + currentId).focus()
    }

    function goFib(event, text) {
        if (event && event.keyCode == 13 && text != "") {
            clearOutput()
            n = text.split(" ")[1]
            if (text.startsWith("fib ") && text.split(" ").length == 2 && is_numeric(n)) {
                goFibHelper("fib", n)
            } else if (text.startsWith("fib_list ") && text.split(" ").length == 2 && is_numeric(n)) {
                goFibHelper("fib_list", n)
            } else {
                errorMessage()
                newCommand()
            }
        }
    }

    function is_numeric(str){
        return /^-?\d+$/.test(str);
    }

    function goFibHelper(op, n) {
        url = "/" + op + "/" + n;

        var xhttp = new XMLHttpRequest()
        xhttp.onreadystatechange = function() {
            if (xhttp.readyState == 4) {
                setOutput(xhttp.responseText, false)
                newCommand()
            }
        };
        xhttp.open("GET", url, true)
        xhttp.send()
    }

    function clearOutput() {
        document.getElementById("fib_output_" + currentId).innerHTML = ""
        document.getElementById("fib_output_" + currentId).style = "color: white;"
    }

    function errorMessage() {
        setOutput("Invalid command. Valid commands are fib n, fib_list n", true)
    }

    function setOutput(text, isError) {
        document.getElementById("fib_output_" + currentId).innerHTML = text
        if (isError) {
            document.getElementById("fib_output_" + currentId).style = "color: #ff2020;"
        }
    }

    function newCommand() {
        document.getElementById("fib_input_" + currentId).readOnly = true

        currentId++

        div = document.createElement("div")
        div.setAttribute("class", "line")
        span = document.createElement("span")
        span.setAttribute("class", "fibonacci prompt")
        span.innerHTML = "$ ~/fib_srv&gt;"
        div.appendChild(span)
        span = document.createElement("span")
        span.setAttribute("class", "fibonacci")

        var input = document.createElement("input");
        input.type = "text";
        input.id = "fib_input_" + currentId
        input.addEventListener("keypress", function(event) { goFib(event, this.value) })
        span.appendChild(input);
        div.appendChild(span)
        document.getElementById("main").appendChild(div)
        document.getElementById("fib_input_" + currentId).focus()

        div = document.createElement("div")
        div.setAttribute("class", "line output")
        span = document.createElement("span")
        span.setAttribute("class", "fibonacci")
        span.id = "fib_output_" + currentId
        div.appendChild(span)
        document.getElementById("main").appendChild(div)
    }
</script>

<h1 align="center">Welcome to the Fibonacci Server</h1>

<div id="main">
    <div class="line">
        <span class="fibonacci prompt">$ ~/fib_srv&gt;</span>
        <span class="fibonacci">
            <input type="text" id="fib_input_0" onkeypress="goFib(event, this.value)">
        </span>
    </div>
    <div class="line output">
        <span class="fibonacci" id="fib_output_0"></span>
    </div>
</div>

</body>
}
